= form_tag(documents_path) do
  = hidden_field_tag :only_uncompleted
  - if current_user.roles.first.name == 'chief_accountant'
    .row.row-accountant-actions
      .span12.pagination-centered
        .btn-group
          %button.btn#accountant-new Новые счета
          %button.btn#accountant-pay Оплатить
          %button.btn#accountant-close Подготовить закрывающие документы
  - elsif current_user.roles.first.name == 'administrative_director'
    .row.row-accountant-actions
      .span12.pagination-centered
        .btn-group
          %button.btn#admindir-close Отправить закрывающие документы
          %button.btn#admindir-return Вернуть акты заказчику
          %button.btn#admindir-receive Получить закрывающие документы
          %button.btn#admindir-return-our Вернуть наши акты
  .row
    .span3
      = select_tag :document_type, options_for_select(@document_types, params[:document_type]), :class => 'span3', :id => 'documents-filter-type'
    .span4
      = select_tag "search[state]", [], :class => 'span4', :id => 'documents-filter-status'
    .span4
      = submit_tag 'Искать', :class => 'btn', :id => 'documents-search-submit'
      %a.dashed#documents-advanced-toggle{:href => '#'} дополнительные параметры
  .row.hide#documents-advanced-search
    .well.well-small.span10
      %table.documents-search
        %tr
          %td.text-right Счет
          %td= text_field_tag("search[schet_num]", '', :class => 'no-margin document-search-input')
          %td= text_field_tag("search[schet_date]", '', :class => 'no-margin document-search-input date-picker', :placeholder => 'Дата')
          %td= text_field_tag("search[schet_sum]", '', :class => 'no-margin document-search-input', :placeholder => 'Сумма')
        %tr
          %td.text-right Акт №
          %td= text_field_tag("search[act_num]", '', :class => 'no-margin document-search-input')
          %td= text_field_tag("search[act_date]", '', :class => 'no-margin document-search-input date-picker', :placeholder => 'Дата')
          %td
        %tr
          %td.text-right Счет фактуры
          %td= text_field_tag("search[fact_num]", '', :class => 'no-margin document-search-input')
          %td= text_field_tag("search[fact_date]", '', :class => 'no-margin document-search-input date-picker', :placeholder => 'Дата')
          %td

- no_documents = true

- if @events and @events.count > 0
  - no_documents = false
  - @events.each do |event|
    %h4.pagination-centered
      = event.name
      %br
      %span.event-date= "(#{event.date_start.strftime('%d.%m.%Y')} - #{event.date_end.strftime('%d.%m.%Y')})"
    - if params[:search][:state] == 'new'
      - documents = event.documents_beznal_schets.accessible_by(current_ability).uncompleted.includes(:company)
    - else
      - documents = event.documents_beznal_schets.accessible_by(current_ability).completed.includes(:company)
    - if documents.any?
      %h5.pagination-centered Приход безналичный
      %table.table.table-striped.table-condensed.table-bordered.table-center.table-links.table-documents
        %thead.thead-small
          %tr
            %th.td-10
            %th.text-left Плательщик
            %th.td-10 Счет №
            %th.td-10 Дата счета
            %th.td-10 Дата оплаты
            %th.td-10 Сумма
            %th.td-10 Включая НДС
            %th.td-10

        - documents.each do |doc|
          %tr{"data-link" => url_for([event, doc])}
            %td= event_state_text doc.state
            %td.text-left= link_to doc.company[:name], doc.company
            %td= doc.num_schet
            %td= doc.date_schet.strftime("%d.%m.%y") unless doc.date_schet.blank?
            %td{:class => ("payment-alert" if doc.payment_date.blank?)}
              = doc.payment_date.strftime("%d.%m.%y") unless doc.payment_date.blank?
            %td #{doc.summ}р.
            %td #{doc.nds}р.
            %td
              .btn-group
                = link_to 'войти', [event, doc], class: 'btn btn-mini'
                %button.btn.btn-mini.dropdown-toggle{"data-toggle" => "dropdown"}
                  %span.caret
                %ul.dropdown-menu.dropdown-menu-narrow.dropdown-menu-left
                  - links_collection(event, doc)

    - if params[:search][:state] == 'new'
      - documents = event.documents_nal_prihods.accessible_by(current_ability).uncompleted
    - else
      - documents = event.documents_nal_prihods.accessible_by(current_ability).completed
    - if documents.any?
      %h5.pagination-centered Приход наличный
      %table.table.table-striped.table-condensed.table-bordered.table-center.table-links.table-documents
        %thead.thead-small
          %tr
            %th.td-10
            %th.text-left Плательщик
            %th.text-left.td-30 Назначение платежа
            %th.td-10 Дата оплаты
            %th.td-10 Сумма
            %th.td-10

        - documents.each do |doc|
          %tr{"data-link" => url_for([event, doc])}
            %td= event_state_text doc.state
            %td.text-left= doc.company
            %td.text-left= doc.description
            %td{:class => ("payment-alert" if doc.date.blank?)}
              = doc.date.strftime("%d.%m.%y") unless doc.date.blank?
            %td #{doc.summ}р.
            %td
              .btn-group
                = link_to 'войти', [event, doc], class: 'btn btn-mini'
                %button.btn.btn-mini.dropdown-toggle{"data-toggle" => "dropdown"}
                  %span.caret
                %ul.dropdown-menu.dropdown-menu-narrow.dropdown-menu-left
                  - links_collection(event, doc)

    - if params[:search][:state] == 'new'
      - documents = event.documents_beznal_rashods.accessible_by(current_ability).uncompleted
    - else
      - documents = event.documents_beznal_rashods.accessible_by(current_ability).completed

    - if documents.any?
      %h5.pagination-centered Расход безналичный
      %table.table.table-bordered.table-condensed.table-bordered.table-center.table-links.table-documents
        %thead.thead-small
          %tr
            %th.td-10
            %th Получатель
            %th.td-25{colspan: 2} Платежные документы
            %th.td-10 Статус
            %th.td-10 Сумма
            %th.td-10 Включая НДС
            %th.td-10 Действия

        - documents.each do |doc|
          %tr{"data-link" => url_for([event, doc])}
            %td{rowspan: 10}= event_state_text doc.state
            %td{rowspan: 5}= doc.company
            %td Счет №
            %td= doc.num_schet
            %td{rowspan: 5}= doc.info_state_act
            %td{rowspan: 10} #{doc.summ}р.
            %td{rowspan: 10} #{doc.nds}р.
            %td{rowspan: 10}
              .btn-group
                = link_to 'войти', [event, doc], class: 'btn btn-mini'
                %button.btn.btn-mini.dropdown-toggle{"data-toggle" => "dropdown"}
                  %span.caret
                %ul.dropdown-menu.dropdown-menu-narrow.dropdown-menu-left
                  - links_collection(event, doc)
          %tr{"data-link" => url_for([event, doc])}
            %td Дата счета
            %td= doc.date_schet.strftime("%d.%m.%y") unless doc.date_schet.blank?
          %tr{"data-link" => url_for([event, doc])}
            %td Дата оплаты
            %td{:class => ("payment-alert" if doc.info_date_pay.blank?)}
              = doc.info_date_pay.strftime("%d.%m.%y") unless doc.info_date_pay.blank?
          %tr{"data-link" => url_for([event, doc])}
            %td № п/п
            %td= doc.info_pp
          %tr{"data-link" => url_for([event, doc])}
            %td Счет фактура №
            %td= doc.info_schet_factura
          %tr{"data-link" => url_for([event, doc])}
            %td{rowspan: 5}= doc.description
            %td Дата сч. фактуры
            %td= doc.info_date_schet.strftime("%d.%m.%Y") unless doc.info_date_schet.blank?
            %td{rowspan: 5}= RASHOD_TYPES[doc.type_rashod.to_s][:title] unless doc.type_rashod.blank?
          %tr{"data-link" => url_for([event, doc])}
            %td Акт №
            %td= doc.info_act
          %tr{"data-link" => url_for([event, doc])}
            %td Дата акта
            %td= doc.info_date_act.strftime("%d.%m.%Y") unless doc.info_date_act.blank?
          %tr{"data-link" => url_for([event, doc])}
            %td Договор №
            %td= doc.dogovor_num
          %tr{"data-link" => url_for([event, doc])}
            %td Дата договора
            %td= doc.dogovor_date.strftime("%d.%m.%Y") unless doc.dogovor_date.blank?

    - if params[:search][:state] == 'new'
      - documents = event.documents_nal_rashods.accessible_by(current_ability).uncompleted
    - else
      - documents = event.documents_nal_rashods.accessible_by(current_ability).completed
    - if documents.any?
      %h5.pagination-centered Расход наличный
      %table.table.table-striped.table-condensed.table-bordered.table-center.table-links.table-documents
        %thead.thead-small
          %tr
            %th.td-10
            %th Получатель
            %th.td-25 Назначение платежа
            %th.td-10 Статус
            %th.td-10 Дата оплаты
            %th.td-10 Сумма
            %th.td-10 Действия

        - documents.each do |doc|
          %tr{"data-link" => url_for([event, doc])}
            %td= event_state_text doc.state
            %td= doc.company
            %td= doc.description
            %td= RASHOD_TYPES[doc.type_rashod.to_s][:title] unless doc.type_rashod.blank?
            %td{:class => ("payment-alert" if doc.date.blank?)}
              = doc.date.strftime("%d.%m.%y") unless doc.date.blank?
            %td #{doc.summ}р.
            %td
              .btn-group
                = link_to 'войти', [event, doc], class: 'btn btn-mini'
                %button.btn.btn-mini.dropdown-toggle{"data-toggle" => "dropdown"}
                  %span.caret
                %ul.dropdown-menu.dropdown-menu-narrow.dropdown-menu-left
                  - links_collection(event, doc)

    %hr.events-sep

- if @documents_beznal_schet and @documents_beznal_schet.any?
  - no_documents = false
  %h5.pagination-centered Приход безналичный
  %table.table.table-striped.table-condensed.table-bordered.table-center.table-links.table-documents
    %thead.thead-small
      %tr
        %th.td-10
        %th.text-left Плательщик
        %th.td-10 Счет №
        %th.td-10 Дата счета
        %th.td-10 Дата оплаты
        %th.td-10 Сумма
        %th.td-10 Включая НДС
        %th.td-10

    - @documents_beznal_schet.each do |doc|
      - if doc.event
        %tr{"data-link" => url_for([doc.event, doc])}
          %td= event_state_text doc.state
          %td.text-left= link_to doc.company[:name], doc.company
          %td= doc.num_schet
          %td= doc.date_schet.strftime("%d.%m.%y") unless doc.date_schet.blank?
          %td{:class => ("payment-alert" if doc.payment_date.blank?)}
            = doc.payment_date.strftime("%d.%m.%y") unless doc.payment_date.blank?
          %td #{doc.summ}р.
          %td #{doc.nds}р.
          %td
            .btn-group
              = link_to 'войти', [doc.event, doc], class: 'btn btn-mini'
              %button.btn.btn-mini.dropdown-toggle{"data-toggle" => "dropdown"}
                %span.caret
              %ul.dropdown-menu.dropdown-menu-narrow.dropdown-menu-left
                - links_collection(doc.event, doc)

- if @documents_nal_prihod and @documents_nal_prihod.any?
  - no_documents = false
  %h5.pagination-centered Приход наличный
  %table.table.table-striped.table-condensed.table-bordered.table-center.table-links.table-documents
    %thead.thead-small
      %tr
        %th.td-10
        %th.text-left Плательщик
        %th.text-left.td-30 Назначение платежа
        %th.td-10 Дата оплаты
        %th.td-10 Сумма
        %th.td-10

    - @documents_nal_prihod.each do |doc|
      - if doc.event
        %tr{"data-link" => url_for([doc.event, doc])}
          %td= event_state_text doc.state
          %td.text-left= doc.company
          %td.text-left= doc.description
          %td{:class => ("payment-alert" if doc.date.blank?)}
            = doc.date.strftime("%d.%m.%y") unless doc.date.blank?
          %td #{doc.summ}р.
          %td
            .btn-group
              = link_to 'войти', [doc.event, doc], class: 'btn btn-mini'
              %button.btn.btn-mini.dropdown-toggle{"data-toggle" => "dropdown"}
                %span.caret
              %ul.dropdown-menu.dropdown-menu-narrow.dropdown-menu-left
                - links_collection(doc.event, doc)

- if @documents_beznal_rashod and @documents_beznal_rashod.any?
  - no_documents = false
  %h5.pagination-centered Расход безналичный
  %table.table.table-bordered.table-condensed.table-bordered.table-center.table-links.table-documents
    %thead.thead-small
      %tr
        %th.td-10
        %th Получатель
        %th.td-25{colspan: 2} Платежные документы
        %th.td-10 Статус
        %th.td-10 Сумма
        %th.td-10 Включая НДС
        %th.td-10 Действия

    - @documents_beznal_rashod.each do |doc|
      - if doc.event or doc.event_id == 0
        %tr{"data-link" => company_beznal_rashod_path(doc)}
          %td{rowspan: 10}= event_state_text doc.state
          %td{rowspan: 5}= doc.company
          %td Счет №
          %td= doc.num_schet
          %td{rowspan: 5}= doc.info_state_act
          %td{rowspan: 10} #{doc.summ}р.
          %td{rowspan: 10} #{doc.nds}р.
          %td{rowspan: 10}
            .btn-group
              = link_to 'войти', company_beznal_rashod_path(doc), class: 'btn btn-mini'
              %button.btn.btn-mini.dropdown-toggle{"data-toggle" => "dropdown"}
                %span.caret
              %ul.dropdown-menu.dropdown-menu-narrow.dropdown-menu-left
                - if doc.event_id == 0
                  - links_collection(0, doc)
                - else
                  - links_collection(doc.event, doc)
        %tr{"data-link" => company_beznal_rashod_path(doc)}
          %td Дата счета
          %td= doc.date_schet.strftime("%d.%m.%y") unless doc.date_schet.blank?
        %tr{"data-link" => company_beznal_rashod_path(doc)}
          %td Дата оплаты
          %td{:class => ("payment-alert" if doc.info_date_pay.blank?)}
            = doc.info_date_pay.strftime("%d.%m.%y") unless doc.info_date_pay.blank?
        %tr{"data-link" => company_beznal_rashod_path(doc)}
          %td № п/п
          %td= doc.info_pp
        %tr{"data-link" => company_beznal_rashod_path(doc)}
          %td Счет фактура №
          %td= doc.info_schet_factura
        %tr{"data-link" => company_beznal_rashod_path(doc)}
          %td{rowspan: 5}= doc.description
          %td Дата сч. фактуры
          %td= doc.info_date_schet.strftime("%d.%m.%Y") unless doc.info_date_schet.blank?
          %td{rowspan: 5}= RASHOD_TYPES[doc.type_rashod.to_s][:title] unless doc.type_rashod.blank?
        %tr{"data-link" => company_beznal_rashod_path(doc)}
          %td Акт №
          %td= doc.info_act
        %tr{"data-link" => company_beznal_rashod_path(doc)}
          %td Дата акта
          %td= doc.info_date_act.strftime("%d.%m.%Y") unless doc.info_date_act.blank?
        %tr{"data-link" => company_beznal_rashod_path(doc)}
          %td Договор №
          %td= doc.dogovor_num
        %tr{"data-link" => company_beznal_rashod_path(doc)}
          %td Дата договора
          %td= doc.dogovor_date.strftime("%d.%m.%Y") unless doc.dogovor_date.blank?

- if @documents_nal_rashod and @documents_nal_rashod.any?
  - no_documents = false
  %h5.pagination-centered Расход наличный
  %table.table.table-striped.table-condensed.table-bordered.table-center.table-links.table-documents
    %thead.thead-small
      %tr
        %th.td-10
        %th Получатель
        %th.td-25 Назначение платежа
        %th.td-10 Статус
        %th.td-10 Дата оплаты
        %th.td-10 Сумма
        %th.td-10 Действия

    - @documents_nal_rashod.each do |doc|
      - if doc.event or doc.event_id == 0
        %tr{"data-link" => company_nal_rashod_path(doc)}
          %td= event_state_text doc.state
          %td= doc.company
          %td= doc.description
          %td= RASHOD_TYPES[doc.type_rashod.to_s][:title] unless doc.type_rashod.blank?
          %td{:class => ("payment-alert" if doc.date.blank?)}
            = doc.date.strftime("%d.%m.%y") unless doc.date.blank?
          %td #{doc.summ}р.
          %td
            .btn-group
              = link_to 'войти', company_nal_rashod_path(doc), class: 'btn btn-mini'
              %button.btn.btn-mini.dropdown-toggle{"data-toggle" => "dropdown"}
                %span.caret
              %ul.dropdown-menu.dropdown-menu-narrow.dropdown-menu-left
                - if doc.event_id == 0
                  - links_collection(0, doc)
                - else
                  - links_collection(doc.event, doc)

- if no_documents
  %h4.pagination-centered Документов не найдено.

#changeEventStateModal.modal.hide.fade{:role => "dialog", :tabindex => "-1"}
  .modal-header
    %button.close{"data-dismiss" => "modal", :type => "button"} ×
    %h3#document-state-title
  .modal-body
    Примечание
    %br
    = text_area_tag(:document_state_note, '', :class => "input-modal-full")
  .modal-footer
    = link_to 'Сохранить', '#', :class => 'btn btn-primary', :id => 'document-state-save', 'data-method' => 'put'

:javascript 
  window.isDocumentsPage = true;
- if params[:search]
  :javascript
    window.documentsState = '#{params[:search][:state]}'

- content_for :title do
  Документы
